<!--
imported-template.html v0.0.4
(c) 2013 Joachim Wester
MIT license
https://github.com/Juicy/imported-template
-->
<link rel="import" href="../polymer/polymer.html">
<script>
  (function () {
    var XHTMLPrototype = Object.create( (HTMLTemplateElement || HTMLElement ).prototype);

    XHTMLPrototype.loadTemplate_ = function() {
      var val = this.getAttribute('content');
      var asIframe = this.getAttribute("iframe") || this.getAttribute("iframe")==="";
      if (val && (val.indexOf('/') === 0 || val.indexOf('./') === 0)) {
        if( asIframe ){
          return this._importIframe(val);
        } else {
          return this._importHTMLImport(val);
        }
      }
      else {
        if( asIframe ){
          return this._importIframe(undefined, encodeURI(val) );
        } else {
          //val is HTML code, insert the partial from the string
          return this._importInline(val);
        }
      }
    };
    /**
     * Import given file, or source as iframe.
     * @public only for debugging.
     * @param  {String} src    file path
     * @param  {String} srcdoc HTML source code
     * @return {imported-template}        self
     */
    XHTMLPrototype._importIframe = function(src, srcdoc){
      this.clear();
      var iframe = this.subTemplate = document.createElement('iframe');
      iframe.src = src;
      srcdoc && (iframe.srcdoc = srcdoc);
      this.parentNode.insertBefore(iframe, this.nextSibling);
      return this;
    };
    /**
     * Import inline html as template
     * @public only for debugging.
     * @param  {String} html html source code
     * @return {imported-template}      self
     */
    XHTMLPrototype._importInline = function(html) {
      if( this.subTemplate ){
        // IDEA: or maybe just this.subTempalte.clear()? - to leave lightDOM template untouched (tomalec)
        this.clear();
      } else {
        this.subTemplate = document.createElement("template");
      }
      this.subTemplate.setAttribute("bind","");
      this.subTemplate.innerHTML = html;
      return this._insertTemplate();
    };
    /**
     * Import partial via HTML Import, and replicate its `<template>`.
     * @IDEA: return promise (if supported) for document load (tomalec)
     * @public only for debugging.
     * @param  {String} href partial URL
     * @return {imported-template}      self
     */
    XHTMLPrototype._importHTMLImport = function(href){
      //href is a URL, load the partial from the HTTP server/cache
      var link = document.createElement('link');
      link.rel = "import";
      link.href = href;
      var xhtml = this;
      link.onload =  function processImportedDocument(){
        xhtml.clear();
        // TODO: clear previous template (tomalec)
        var templates = this.import.querySelectorAll("template");
        var template;
        // debugger
        // many teamplates (merged partial), wrap them with one.
        if( templates.length > 1 ){
          var template = this.import.createElement("template");
          template.setAttribute("bind","");
          // move entire content to tempalte
          // TODO: check if moving by text is faster, 
          //      as we assume those are templates => document fragments (tomalec)
          for( var nodeNo=0; nodeNo < templates.length; nodeNo++){
            template.content.appendChild(templates[nodeNo]);
          }
          this.import.body.appendChild(template);

        } else if(templates.length == 1) {
          template = templates[0];
        } else { //there is no template in the response. 
          // it could be a stack trace, or HTML document with imports, etc. which could be hard to handle
          console.error("DON'T misbehave! At least one <template> tag is expected in content body", this.import.body.innerHTML);
          return;
        }
        // TODO: rewrite binding attributes here (tomalec)
        // var xhtml.subTemplate = document.importNode(template.content, true);
        xhtml.subTemplate = document.importNode(template, true);
        xhtml._insertTemplate();

      };
      // guessed workaround for Polyjuice/Launcher#82, Polymer/polymer#554
      setTimeout( function appendAsync(){
          document.head.appendChild(link);
      });
      return this;
    };

    /**
     * Insert template into DOM.
     * @public only for debugging.
     * @param  {String} href partial URL
     * @return {imported-template}      self
     */
    XHTMLPrototype._insertTemplate = function(){
      if(window.PolymerExpressions) {
        this.subTemplate.bindingDelegate = new PolymerExpressions; //use PolymerExpressions if available. This allows <template if="{{val == 1}}">, etc
      }
      this.parentNode.insertBefore(this.subTemplate, this.nextSibling);
      // debugger
      this.subTemplate.model = this.model;
      return this;
    };

    /**
     * Empty xhml content.
     * @requires HTMLTemplateElement#clear (https://github.com/Polymer/TemplateBinding/blob/51df59c16e0922dec041cfe604016aac00918d5d/src/TemplateBinding.js#L595)
     * @extends HTMLTemplateElement.prototype.clear
     * @return  see HTMLTemplateElement.prototype.clear
     */
    XHTMLPrototype.clear = function(){
      // return false;
      return this.subTemplate
            && ( !this.subTemplate.clear || this.subTemplate.clear() || true)
            && this.subTemplate.parentNode.removeChild(this.subTemplate);
      // IDEA: clear also content? (tomalec)        
      //      && HTMLTemplateElement.prototype.clear.call(this);
    }


    XHTMLPrototype.attachedCallback = function () {
      var that = this;
      this.loadTemplate_();

      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === "attributes" && 
                (mutation.attributeName === "content" || mutation.attributeName === "iframe") ) {
            that.loadTemplate_();
          }
        });
      });
      observer.observe(this, {
        attributes: true
      });
    };

    document.registerElement('imported-template', {
      prototype: XHTMLPrototype,
      extends: "template"
    });


   
  })();
</script>